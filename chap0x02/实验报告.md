# HTTP代理服务器实验报告

### 实验要求

- [x] 在Kali Linux中安装tinyproxy，然后用主机设置浏览器代理指向tinyproxy建立的HTTP正向代理
- [x] 在Kali中用wireshark抓包，分析抓包过程，理解HTTP正向代理HTTPS流量的特点

### 正向代理机制模拟

- 网关：代理服务器

- 靶机：服务器

- 攻击者主机：客户端

- 网络拓扑图

  ![](img/网络拓扑图.png)

### 实验环境

- 主机基本信息

  |    主机名称    |       网卡        |     IP地址     |
  | :------------: | :---------------: | :------------: |
  | Gateway-Debian |     NAT 网络      |   10.0.2.15    |
  |                |   Host-Only网络   | 192.168.93.14  |
  |                | 内部网络，intnet1 |  172.16.111.1  |
  |                | 内部网络，intnet2 |  172.16.222.1  |
  | Attacker-Kali  |     NAT 网络      |    10.0.2.5    |
  | Victim-Kali-1  |      intnet1      | 172.16.111.110 |

- 网络连通性测试

  - 攻击者可以上网并且可以ping通网关

    ![](img/攻击者可以上网并且可以ping通网关.png)

  - 攻击者不能ping通靶机

    ![](img/攻击者不能ping通靶机.png)
    
  - 网关可以ping通攻击者和靶机
  
    ![](img/网关可以ping通攻击者和靶机.png)
  
  - 靶机可以ping攻击者、网关，并且可以上网
  
    ![](img/测试靶机的连通性.png)

### 实验过程

- 网关

  ```bash
  # 下载tinyproxy
  sudo apt-get update 
  sudo apt-get install tinyproxy
  
  # 编辑tinyproxy，取消Allow 10.0.0.0/8行首注释
  sudo vim /etc/tinyproxy/tinyproxy.conf
  
  # 开启tinyproxy服务
  sudo /etc/init.d/tinyproxy start
  ```
  - 查看`tinyproxy.conf` 文件的端口

    ![](img/端口.png)

- 攻击者主机

  - 打开浏览器，在 `Preferences` 中输入 `Connection` 来搜索 `Connection Settings`

    ![](img/搜索connection.png)

  - 选择 `Manual proxy configuration` ，并在 `HTTP Proxy` 一栏输入网关的NAT网络地址，端口和 `tinyproxy.conf`文件中的一致

    ![](img/攻击者配置代理服务.png)

- 靶机开启 `apache2` 服务

  ```bash
  # 开启服务
  sudo service apache2 start
  ```
  
- 攻击者主机

  - 进行抓包
  
  	```bash
  	sudo tcpdump -i eth0 -n -w 20210918.1.pcap
  	```
  
  	![](img/进行抓包.png)

	- 访问靶机

  	![](img/访问靶机.png)

  	![](img/访问靶机2.png)

	- 分析抓包结果，能看到代理`1.1 tinyproxy (tinyproxy/1.10.0)`，但是看不到具体的信息（例如ip地址）

    ![](img/攻击者抓包分析.png)
  

- 网关

  - 抓包并分析

    ```bash
    sudo tcpdump -i enp0s3 -n -w 20210918.2.pcap
    
    # 复制文件到本机桌面上
    scp cuc@192.168.93.14:/home/cuc/workspace/20210918.2.pcap ./
    ```

    ![](img/网关抓包分析.png)

  - **网关（代理服务器）行为分析**
    - 网关保留HTTP GET请求内容，若攻击者主机（客户端）的浏览器不清除历史记录，则下次访问同样的HTTP服务时用时非常短
    - 若在网关设置防火墙规则过滤攻击者主机（客户端）发出的的请求，则攻击者主机（客户端）依然无法访问靶机端（服务器）的HTTP服务
    - 代理层可以理解HTTP报文

- 靶机

  - 抓包分析

    ![](img/靶机抓包分析.png)

  - **靶机（服务器）行为分析**

    - HTTP协议中出现Via字段，说明网关（代理服务器）正在提供代理服务
    - 攻击者主机IP地址、以太网接口均未暴露

- 访问HTTPS站点

  - 访问百度

    ![](img/访问百度.png)

  - 抓包分析

    - 通过代理访问HTTPS站点

      ![](img/通过代理访问HTTPS站点.png)

    - HTTPS服务建立连接后，用户与网站进行加密通信

      ![](img/加密通信.png)

### 实验遇到的问题

#### 问题一

- 靶机ping攻击者的时候出现 `Network is unreachable`

  ![](img/靶机无法ping攻击者.png)

**解决方法**

- 把网关【Gateway-Debian】打开

#### 问题二

- `apt-get update` 出现错误

  ![](img/apt-get更新出现错误.png)

**解决方法**

- 输入 `sudo apt update`

### 参考资料

[2020-ns-public-ididChan](https://github.com/CUCCS/2020-ns-public-ididChan/blob/chap0x03/chap0x03/%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A.md)

[2021-ns-public-Lychee00](https://github.com/CUCCS/2021-ns-public-Lychee00/blob/chap0x03/chap0x03/report03.md)

